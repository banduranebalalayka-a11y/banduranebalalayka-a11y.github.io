<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–∞–ª—å–Ω–æ–≥–æ</title>
    <style>
        :root { --bg-color: #2e2e2e; --fg-color: #ffffff; --entry-bg: #3e3e3e; --btn-bg: #4e4e4e; --success-color: #60a860; --error-color: #c06060; }
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
        html, body { overscroll-behavior-y: contain; }
        body { margin: 0; line-height: inherit; background-color: var(--bg-color); color: var(--fg-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        h1 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; text-align: center; margin-bottom: 0; }
        h2 { font-size: 1.25rem; line-height: 1.75rem; font-weight: 700; margin-top: 0; margin-bottom: 0.75rem; text-align: center; }
        h3 { font-size: 1.1rem; line-height: 1.5rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #ccc; }
        p { margin: 0; }
        pre { font-family: monospace; font-size: 1em; margin: 1rem 0; }
        hr { border-top: 1px solid #4a4a4a; margin: 1.5rem 0; }
        sub { font-size: 0.7em; vertical-align: sub; line-height: 0; position: relative; top: 0.2em; }
        .active { display: block !important; }
        .screen { 
            display: none; 
            padding: 1rem; 
            min-height: 100vh;
            padding-top: calc(1rem + env(safe-area-inset-top));
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            padding-left: calc(1rem + env(safe-area-inset-left));
            padding-right: calc(1rem + env(safe-area-inset-right));
        }
        .btn { background-color: var(--btn-bg); color: var(--fg-color); width: 100%; padding: 0.75rem; border-radius: 0.5rem; text-align: center; font-size: 1rem; margin-bottom: 0.5rem; cursor: pointer; transition: transform 0.1s, filter 0.1s; }
        .btn:active { transform: scale(0.98); filter: brightness(0.9); }
        .btn-instruction { background-color: #3a5a9a; font-weight: 700; }
        .btn-back { background-color: #666; }
        .btn-primary { background-color: var(--success-color); font-weight: 700; }
        .btn-clear { width: auto; padding: 0.625rem 1rem; margin-bottom: 0; flex-shrink: 0; background-color: #5a5a5a; }
        .input-group { margin-bottom: 0.75rem; }
        .input-wrapper { display: flex; align-items: center; gap: 8px; }
        .input-wrapper input { flex-grow: 1; }
        .input-group label { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
        .input-group label .label-text { flex: 1; margin-right: 10px; }
        .input-group input[type="number"] { -webkit-appearance: none; background-color: var(--entry-bg); color: var(--fg-color); width: 100%; padding: 0.625rem; border-radius: 0.5rem; border: 1px solid #555; font-size: 1rem; }
        .switch-container { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
        .switch-container .label-text { flex: 1; margin-right: 10px; }
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 31px; }
        .slider:before { position: absolute; content: ""; height: 23px; width: 23px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .result-box { margin-top: 1rem; }
        .result-value { font-size: 1.75rem; line-height: 2.25rem; font-weight: 700; color: var(--success-color); }
        .base-result { font-size: 1.3rem; font-weight: 700; color: var(--success-color); }
        .result-diff { font-size: 1rem; line-height: 1.5rem; }
        .lock-icon { font-size: 0.8rem; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 100; }
        #help-modal, #alert-modal, #formula-modal { z-index: 110; }
        .modal-content { background-color: var(--bg-color); padding: 1.25rem; border-radius: 0.75rem; width: 90%; max-width: 500px; border: 1px solid #555; text-align: center; display: flex; flex-direction: column; max-height: 90vh; }
        #help-message { max-height: 60vh; overflow-y: auto; white-space: pre-wrap; text-align: left !important; }
        .modal-content pre { flex-grow: 1; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; text-align: left; background-color: var(--entry-bg); padding: 0.625rem; border-radius: 0.5rem; }
        .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; } .mt-4 { margin-top: 1rem; } .mt-8 { margin-top: 2rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-gray-500 { color: #6b7280; }
        .font-bold { font-weight: 700; }
        .title-wrapper { display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; }
        .help-btn { display: inline-flex; justify-content: center; align-items: center; width: 24px; height: 24px; background-color: #555; color: white; border-radius: 50%; cursor: pointer; font-weight: bold; margin-left: 10px; flex-shrink: 0; transition: background-color 0.2s; user-select: none; }
        .help-btn:active { background-color: #777; }
        #distribution-modal .modal-content { max-width: 95vw; }
        #dist-table-container { overflow-x: auto; flex-grow: 1; }
        #dist-table { display: grid; font-size: 0.8rem; min-width: 1200px; }
        #dist-table .header { background-color: var(--btn-bg); font-weight: bold; position: sticky; top: 0; z-index: 10; text-align: center;}
        #dist-table .cell { padding: 8px 4px; border-bottom: 1px solid #444; border-right: 1px solid #444; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #dist-table .cell:last-child { border-right: none; }
        #dist-table .cell input[type=number] { width: 60px; padding: 4px; text-align: center; font-size: 0.8rem; }
        .dist-footer { padding-top: 1rem; font-size: 0.9rem; }
    </style>
</head>
<body class="antialiased">
    <div id="app-container">
        <div id="screen-subdivision" class="screen">
            <div class="title-wrapper">
                <h1>–ö—Ä–æ–∫ 1: –í–∏–±–µ—Ä—ñ—Ç—å –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª</h1>
                <div class="help-btn" onclick="showHelp('–ö—Ä–æ–∫ 1', '–ü–æ–Ω—è—Ç–Ω–æ –≤—Å–µ –∑ —Ç–æ–±–æ—é, –∫–æ—Ä–æ—Ç—à–µ —á–∏—Ç–∞–π —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é. –í–æ–Ω–∞ —Ç—Ä–æ—à–∫–∏ –Ω–∏–∂—á–µ —ñ –Ω–∞–ø–∏—Å–∞–Ω–æ –Ü–ù–°–¢–†–£–ö–¶–Ü–Ø.')">?</div>
            </div>
            <div id="subdivision-buttons"></div>
            <p class="text-center text-xs text-gray-500 mt-8">created by Artem Bandura v1.0.0.3</p>
        </div>

        <div id="screen-type" class="screen">
            <div class="title-wrapper">
                <h1>–ö—Ä–æ–∫ 2: –í–∏–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –∞–≤—Ç–æ</h1>
                <div class="help-btn" onclick="showHelp('–ö—Ä–æ–∫ 2', '–°–ø–æ—Ä—Ç-–∫–∞—Ä–∏, –≥—ñ–ø–µ—Ä-–∫–∞—Ä–∏, –º–∞–≥–∞–∑–∏–Ω–Ω—ñ –≤—ñ–∑–æ—á–∫–∏ —ñ —Ç–∞–Ω–∫–∏ - –∑–∞–≤–µ–∑—É—Ç—å –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É —Ç–∏–∂–Ω—ñ...')">?</div>
            </div>
            <div id="type-buttons"></div>
            <div class="btn btn-back mt-8" onclick="showScreen('screen-subdivision')">&lt; –ù–∞–∑–∞–¥</div>
            <p class="text-center text-xs text-gray-500 mt-8">created by Artem Bandura v1.0.0.3</p>
        </div>

        <div id="screen-car" class="screen">
            <div class="title-wrapper">
                <h1>–ö—Ä–æ–∫ 3: –í–∏–±–µ—Ä—ñ—Ç—å –∞–≤—Ç–æ–º–æ–±—ñ–ª—å</h1>
                <div class="help-btn" onclick="showHelp('–ö—Ä–æ–∫ 3', '–Ø–∫—â–æ –∑–∞–π—à–æ–≤ –Ω–µ —Ç—É–¥–∏, —Ç–∏—Ü—è–π –Ω–∞–∑–∞–¥, –∞ —è–∫—â–æ —Ç—É–¥–∏... –ù—É–º–æ –ø–æ–¥–∏–≤–∏–º–æ—Å—å, —â–æ –≤ –Ω–∞—Å —â–µ –Ω–∞ —Ö–æ–¥—É.')">?</div>
            </div>
            <div id="car-buttons"></div>
            <div class="btn btn-back mt-8" onclick="showScreen('screen-type')">&lt; –ù–∞–∑–∞–¥</div>
            <p class="text-center text-xs text-gray-500 mt-8">created by Artem Bandura v1.0.0.3</p>
        </div>

        <div id="screen-calculator" class="screen">
            <div id="car-info" class="text-center mb-4"></div>
            <div class="btn btn-back" onclick="go_to_start()">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤—Ç–æ</div>
            <div id="calculator-content"></div>
            <p class="text-center text-xs text-gray-500 mt-8">created by Artem Bandura v1.0.0.3</p>
        </div>
        
        <div id="formula-modal" class="modal">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h2 id="formula-modal-title" class="text-center">–§–æ—Ä–º—É–ª–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É</h2>
                <pre id="formula-text" class="my-4"></pre>
                <div class="btn" onclick="copyFormula()">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</div>
                <div class="btn btn-back mt-2" onclick="closeModal('formula-modal')">–ó–∞–∫—Ä–∏—Ç–∏</div>
            </div>
        </div>
        
        <div id="alert-modal" class="modal">
            <div class="modal-content">
                <h2 id="alert-title" class="mb-4">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h2>
                <p id="alert-message" class="mb-4"></p>
                <div class="btn" onclick="closeModal('alert-modal')">OK</div>
            </div>
        </div>

        <div id="help-modal" class="modal">
            <div class="modal-content">
                <h2 id="help-title" class="mb-4">–ü–æ—è—Å–Ω–µ–Ω–Ω—è</h2>
                <p id="help-message" class="mb-4"></p>
                <div class="btn btn-back" onclick="closeModal('help-modal')">–ù–∞–∑–∞–¥</div>
            </div>
        </div>
        
        <div id="distribution-modal" class="modal">
            <div class="modal-content">
                <div class="title-wrapper" style="margin-bottom: 1rem;">
                    <h2>–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö</h2>
                    <div class="help-btn" onclick="showHelp('–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö', `–¶–µ –Ω–∞–π–ø–æ—Ç—É–∂–Ω—ñ—à–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É –Ω–∞—à—ñ–π –ø—Ä–æ–≥—Ä–∞–º—ñ...`)">?</div>
                </div>
                <div id="dist-table-container">
                    <div id="dist-table"></div>
                </div>
                <div class="dist-footer">
                    <div id="remaining-dist-label"></div>
                    <div id="remaining-cargo-label"></div>
                </div>
                <div class="btn mt-4" onclick="addRouteRow()">+ –î–æ–¥–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</div>
                <div class="btn btn-primary" onclick="runDistribution()">–†–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏</div>
                <div class="btn btn-back mt-2" onclick="closeModal('distribution-modal')">–ù–∞–∑–∞–¥</div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA AND CONSTANTS ---
        // –ü–æ—á–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è, —è–∫—â–æ –≤ –ø–∞–º'—è—Ç—ñ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω—ñ—á–æ–≥–æ –Ω–µ–º–∞—î
        const INITIAL_CARS_DATA = {
            "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è": { "–õ–µ–≥–∫–æ–≤–∞": { "Toyota Hilux 6286 –ì2": {"consumption": 10.5, "aircon": true, "cargo": false, "engine_type": "–¥–∏–∑–µ–ª—å"} } },
            "–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è": { "–ë—É—Å": { "Renault Trafic 6313 –ì2": {"consumption": 11, "aircon": false, "cargo": false, "engine_type": "–¥–∏–∑–µ–ª—å"} }, "–í–∞–Ω—Ç–∞–∂—ñ–≤–∫–∞": { "MAN TGS 33.400 6X6 6298 –ì2": {"consumption": 32, "aircon": true, "cargo": true, "engine_type": "–¥–∏–∑–µ–ª—å"} } },
            "–ú–µ–¥–∏—á–Ω–∏–π –ø—É–Ω–∫—Ç": { "–°–ø–µ—Ü.—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç": { "Peugeot Boxer 6244 –ì2": {"consumption": 12.5, "aircon": true, "cargo": false, "engine_type": "–¥–∏–∑–µ–ª—å"} } },
            "1 –†–æ—Ç–∞": { "–õ–µ–≥–∫–æ–≤–∞": { "Toyota Hilux 6287 –ì2": {"consumption": 10.5, "aircon": true, "cargo": false, "engine_type": "–¥–∏–∑–µ–ª—å"} }, "–ë—É—Å": { "Ford Transit 3050 –ì2": {"consumption": 13, "aircon": false, "cargo": false, "engine_type": "–¥–∏–∑–µ–ª—å"}, "Ford Transit 6271 –ì2": {"consumption": 9.5, "aircon": false, "cargo": false, "engine_type": "–¥–∏–∑–µ–ª—å"}, "Mercedes-Benz 316–°DI 2794 –ì2": {"consumption": 12.5, "aircon": false, "cargo": false, "engine_type": "–¥–∏–∑–µ–ª—å"} }, "–í–∞–Ω—Ç–∞–∂—ñ–≤–∫–∞": { "MAN TGS 33.400 6X6 6297 –ì2": {"consumption": 32, "aircon": true, "cargo": true, "engine_type": "–¥–∏–∑–µ–ª—å"}, "MAN TGS 13.320 4X4 6361 –ì2": {"consumption": 27, "aircon": true, "cargo": true, "engine_type": "–¥–∏–∑–µ–ª—å"} } },
            "2 –†–æ—Ç–∞": {"–õ–µ–≥–∫–æ–≤–∞": {}, "–ë—É—Å": {}, "–í–∞–Ω—Ç–∞–∂—ñ–≤–∫–∞": {}}, "3 –†–æ—Ç–∞": {"–õ–µ–≥–∫–æ–≤–∞": {}, "–ë—É—Å": {}, "–í–∞–Ω—Ç–∞–∂—ñ–≤–∫–∞": {}}, "4 –†–æ—Ç–∞": {"–õ–µ–≥–∫–æ–≤–∞": {}, "–ë—É—Å": {}, "–í–∞–Ω—Ç–∞–∂—ñ–≤–∫–∞": {}}, "5 –†–æ—Ç–∞": {"–õ–µ–≥–∫–æ–≤–∞": {}, "–ë—É—Å": {}, "–í–∞–Ω—Ç–∞–∂—ñ–≤–∫–∞": {}}
        };

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: —Å–ø–æ—á–∞—Ç–∫—É –∑ localStorage, —è–∫—â–æ –Ω–µ –≤–∏–π–¥–µ - –∑ INITIAL_CARS_DATA
        function getCarData() {
            const dataFromStorage = localStorage.getItem('CARS_DATA');
            try {
                if (dataFromStorage) {
                    return JSON.parse(dataFromStorage);
                }
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –¥–∞–Ω–∏—Ö –∑ localStorage, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ.", e);
            }
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–æ–ø—ñ—é, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –≤–∏–ø–∞–¥–∫–æ–≤–æ—ó –∑–º—ñ–Ω–∏ –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
            return JSON.parse(JSON.stringify(INITIAL_CARS_DATA));
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
        let CARS_DATA = getCarData();

        const ROAD_COEFFS = { "–†—É—Ö –ø–æ –¥–æ—Ä–æ–∑—ñ –∑ –ø–æ–∫—Ä–∞—â–µ–Ω–∏–º –ø–æ–∫—Ä–∏—Ç—Ç—è–º": 0.85, "–°–µ–ª–∞, –°–µ–ª–∏—â–∞, –°–ú–¢, –º–∞–ª—ñ –º—ñ—Å—Ç–∞": 1.05, "–í–µ–ª–∏–∫—ñ –º—ñ—Å—Ç–∞, –æ–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏": 1.1, "–ü–æ –±—Ä—É–∫–æ–≤–æ-—â–µ–±–Ω–µ–≤–æ–º—É —à–æ—Å–µ —ñ —Ç–≤–µ—Ä–¥—ñ–π —Å—Ç–µ–ø–æ–≤—ñ–π —Ü—ñ–ª–∏–Ω—ñ": 1.25, "–ü–æ “ë—Ä—É–Ω—Ç–æ–≤–∏—Ö –¥–æ—Ä–æ–≥–∞—Ö —ñ –¥–æ—Ä–æ–≥–∞—Ö –∑ –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω–∏–º–∏ –ø—ñ—Å–∫–∞–º–∏": 1.3, "–£ –≤–∞–∂–∫–∏—Ö –¥–æ—Ä–æ–∂–Ω—ñ—Ö —É–º–æ–≤–∞—Ö (–±–µ–∑–¥–æ—Ä—ñ–∂–∂—è, —Å–Ω—ñ–≥, –ø—ñ—Å–æ–∫)": 1.35, "–ö–∏—ó–≤, –î–Ω—ñ–ø—Ä–æ, –•–∞—Ä–∫—ñ–≤ —ñ –ø–æ–¥—ñ–±–Ω—ñ": 1.15, };
        const SEGMENT_ORDER = [ "–†—É—Ö –ø–æ –¥–æ—Ä–æ–∑—ñ –∑ –ø–æ–∫—Ä–∞—â–µ–Ω–∏–º –ø–æ–∫—Ä–∏—Ç—Ç—è–º", "–°–µ–ª–∞, –°–µ–ª–∏—â–∞, –°–ú–¢, –º–∞–ª—ñ –º—ñ—Å—Ç–∞", "–í–µ–ª–∏–∫—ñ –º—ñ—Å—Ç–∞, –æ–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏", "–ö–∏—ó–≤, –î–Ω—ñ–ø—Ä–æ, –•–∞—Ä–∫—ñ–≤ —ñ –ø–æ–¥—ñ–±–Ω—ñ", "–ü–æ –±—Ä—É–∫–æ–≤–æ-—â–µ–±–Ω–µ–≤–æ–º—É —à–æ—Å–µ —ñ —Ç–≤–µ—Ä–¥—ñ–π —Å—Ç–µ–ø–æ–≤—ñ–π —Ü—ñ–ª–∏–Ω—ñ", "–ü–æ “ë—Ä—É–Ω—Ç–æ–≤–∏—Ö –¥–æ—Ä–æ–≥–∞—Ö —ñ –¥–æ—Ä–æ–≥–∞—Ö –∑ –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω–∏–º–∏ –ø—ñ—Å–∫–∞–º–∏", "–£ –≤–∞–∂–∫–∏—Ö –¥–æ—Ä–æ–∂–Ω—ñ—Ö —É–º–æ–≤–∞—Ö (–±–µ–∑–¥–æ—Ä—ñ–∂–∂—è, —Å–Ω—ñ–≥, –ø—ñ—Å–æ–∫)" ];
        const ADDITIVE_COEFFS = { "–ó–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ –Ω–∏–∂—á–µ 0": 0.1, "–û–∂–µ–ª–µ–¥–∏—Ü—è": 0.1, "–ö–æ–Ω–¥–∏—Ü—ñ–æ–Ω–µ—Ä": 0.1, "–ü—Ä–∏ —Ä—É—Å—ñ 90 –∫–º —ñ –±—ñ–ª—å—à–µ –¥–ª—è MAN": 0.05, "–ü—Ä–∏ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—ñ '—Ç–µ–Ω–¥—ñ—Ç–Ω–∏—Ö' –≤–∞–Ω—Ç–∞–∂—ñ–≤": 0.1, "–í—ñ–∫ > 5 —Ä–æ–∫—ñ–≤ –∞–±–æ –ø—Ä–æ–±—ñ–≥ > 100 —Ç–∏—Å.–∫–º": 0.03, "–í—ñ–∫ > 8 —Ä–æ–∫—ñ–≤ –∞–±–æ –ø—Ä–æ–±—ñ–≥ > 150 —Ç–∏—Å.–∫–º": 0.05, "–í—ñ–∫ > 11 —Ä–æ–∫—ñ–≤ –∞–±–æ –ø—Ä–æ–±—ñ–≥ > 250 —Ç–∏—Å.–∫–º": 0.07, "–í—ñ–∫ > 14 —Ä–æ–∫—ñ–≤ –∞–±–æ –ø—Ä–æ–±—ñ–≥ > 400 —Ç–∏—Å.–∫–º": 0.09 };
        const CARGO_COEFFS = {"–¥–∏–∑–µ–ª—å": 1.3, "–±–µ–Ω–∑–∏–Ω": 2.0 };
        let state = { subdivision: null, type: null, carName: null, carInfo: null };

        function showScreen(screenId) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(screenId).classList.add('active'); window.scrollTo(0, 0); }
        function showAlert(message, title = "–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è") { document.getElementById('alert-title').textContent = title; document.getElementById('alert-message').textContent = message; document.getElementById('alert-modal').style.display = 'flex'; }
        function showHelp(title, message) { document.getElementById('help-title').textContent = title; document.getElementById('help-message').textContent = message; document.getElementById('help-modal').style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function go_to_start() {
            resetCalculator();
            routeData = []; // Clear distribution data
            showScreen('screen-subdivision');
        }

        function renderSubdivisions() {
            const container = document.getElementById('subdivision-buttons');
            container.innerHTML = '';
            
            const instructionBtn = document.createElement('div');
            instructionBtn.className = 'btn btn-instruction';
            instructionBtn.textContent = '–Ü–ù–°–¢–†–£–ö–¶–Ü–Ø';
            const instructionText = `	–ë–û–ô–û–í–ò–ô –ê–ù–ê–õ–Ü–ó –§–£–ù–ö–¶–Ü–û–ù–ê–õ–£
	–ó–ê–ì–ê–õ–¨–ù–Ü –ü–†–ò–ù–¶–ò–ü–ò –†–û–ë–û–¢–ò
–¶–µ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ‚Äî —Ü–µ —Ç–æ–±—ñ –Ω–µ —Ü–∏–≤—ñ–ª—å–Ω–∞ —ñ–≥—Ä–∞—à–∫–∞. –í—ñ–Ω —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∏–π, —â–æ–± —Ç–∏—Ü—è—Ç–∏ —Ü–∏—Ñ—Ä–∏ —ñ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –≥–æ—Ç–æ–≤–∏–π –∑–≤—ñ—Ç, —è–∫–∏–π –º–æ–∂–Ω–∞ –ø—ñ–¥—à–∏—Ç–∏ –¥–æ –ø–æ–¥–æ—Ä–æ–∂–Ω—å–æ–≥–æ –ª–∏—Å—Ç–∞. –í—ñ–Ω —Å–∞–º —Ä–∞—Ö—É—î, —Å–∫—ñ–ª—å–∫–∏ —Ç–≤–æ—è –º–∞—à–∏–Ω–∞ –∂–µ—Ä–ª–∞, —â–æ–± —Ç–æ–±—ñ –Ω–µ –¥–æ–≤–µ–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —Ü–µ –≤—Ä—É—á–Ω—É.
	–ö–†–û–ö 1: –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª. –¢–∏ —Å–ø–æ—á–∞—Ç–∫—É –æ–±–∏—Ä–∞—î—à —Å–≤—ñ–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª. –Ø–∫—â–æ –ø—Ä–æ–º–∞—Ö–Ω–µ—à—Å—è ‚Äî –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ, –∞–ª–µ —Å–∏—Å—Ç–µ–º–∞ –¥–∞—Å—Ç—å –ø–æ –ø–∏—Ü—ñ, —è–∫—â–æ –≤ –Ω—å–æ–º—É –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ—ó –º–∞—à–∏–Ω–∏.
	–ö–†–û–ö 2: –¢–∏–ø –∞–≤—Ç–æ. –î–∞–ª—ñ –æ–±–∏—Ä–∞—î—à —Ç–∏–ø –º–∞—à–∏–Ω–∏: –ª–µ–≥–∫–æ–≤–∞, –±—É—Å —á–∏ –≤–∞–Ω—Ç–∞–∂—ñ–≤–∫–∞. –¶–µ —è–∫ –≤–∏–±—Ä–∞—Ç–∏, –∑ —è–∫–æ—é –∑–±—Ä–æ—î—é —Ç–∏ –ø—ñ–¥–µ—à —É –±—ñ–π.
	–ö–†–û–ö 3: –ê–≤—Ç–æ–º–æ–±—ñ–ª—å. –ù–∞—Ä–µ—à—Ç—ñ, —Ç–∏ –≤–∏–±–∏—Ä–∞—î—à —Å–≤–æ—é ‚Äú–ª–∞—Å—Ç—ñ–≤–∫—É‚Äù –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º –Ω–æ–º–µ—Ä–æ–º. –°–∏—Å—Ç–µ–º–∞ –∑–Ω–∞—î —ó—ó –±–∞–∑–æ–≤—É –Ω–æ—Ä–º—É –≤–∏—Ç—Ä–∞—Ç–∏ –ø–∞–ª—å–Ω–æ–≥–æ, —Ç–∏–ø –¥–≤–∏–≥—É–Ω–∞ (–¥–∏–∑–µ–ª—å/–±–µ–Ω–∑–∏–Ω) —Ç–∞ —á–∏ —î –≤ –Ω—ñ–π –∫–æ–Ω–¥–∏—Ü—ñ–æ–Ω–µ—Ä.
	–ö–†–û–ö 4: –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –Ü –í–í–ï–î–ï–ù–ù–Ø –î–ê–ù–ò–•
–¢—É—Ç –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è —Å–ø—Ä–∞–≤–∂–Ω—è –º–∞–≥—ñ—è, –¥–µ —Ç–∏ –º–æ–∂–µ—à –≤–∏–±—Ä–∞—Ç–∏ –æ–¥–∏–Ω —ñ–∑ –¥–≤–æ—Ö —à–ª—è—Ö—ñ–≤.
	–®–ª—è—Ö 1: –ß–µ—Å–Ω–∏–π. –í–±–∏–≤–∞—î—à –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –æ–¥–æ–º–µ—Ç—Ä–∞ (–Ω–∞ –ø–æ—á–∞—Ç–∫—É —ñ –≤ –∫—ñ–Ω—Ü—ñ) —Ç–∞ —Ä—É—Ö –ø–∞–ª—å–Ω–æ–≥–æ (–Ω–∞—è–≤–Ω—ñ—Å—Ç—å, —Å–∫—ñ–ª—å–∫–∏ –æ—Ç—Ä–∏–º–∞–≤ —ñ —Å–∫—ñ–ª—å–∫–∏ –∑–∞–ª–∏—à–∏–ª–æ—Å—è). –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î –∑–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–æ–±—ñ–≥ —ñ –≤–∏—Ç—Ä–∞—Ç—É –ø–∞–ª—å–Ω–æ–≥–æ —ñ –≤—Å—Ç–∞–≤–ª—è—î —ó—Ö —É –ø–æ–ª–µ "–ú–µ—Ç–∞". –¶–µ –¥–ª—è —Ç–∏—Ö, —Ö—Ç–æ —Ö–æ—á–µ "–∑–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ —Ä–µ–∞–ª—å–Ω—ñ—Å—Ç—å".
	–®–ª—è—Ö 2: –•—É–¥–æ–∂–Ω—ñ–π. –ó–∞–º—ñ—Å—Ç—å –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤ –æ–¥–æ–º–µ—Ç—Ä–∞, —Ç–∏ –º–æ–∂–µ—à –≤—Ä—É—á–Ω—É –≤–≤–µ—Å—Ç–∏ –±–∞–∂–∞–Ω–∏–π "–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–æ–±—ñ–≥" —Ç–∞ "–ó–∞–≥–∞–ª—å–Ω—É –≤–∏—Ç—Ä–∞—Ç—É" –≤ —Ä–æ–∑–¥—ñ–ª—ñ "–ú–µ—Ç–∞". –¶–µ –¥–ª—è —Ç–∏—Ö, —Ö—Ç–æ –ª—é–±–∏—Ç—å –º–∞–ª—é–≤–∞—Ç–∏, –∞ –Ω–µ —ó–∑–¥–∏—Ç–∏.
	–ö–†–û–ö 5: –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –¢–ê –ö–û–†–ï–ì–£–í–ê–ù–ù–Ø
–¶–µ —è–∫ –Ω–∞–≤—ñ—Å–∏—Ç–∏ –Ω–∞ —Ç–∞–Ω–∫ –¥–æ–¥–∞—Ç–∫–æ–≤—É –±—Ä–æ–Ω—é.
-–í—ñ–¥—Ä—ñ–∑–∫–∏ —à–ª—è—Ö—É. –¢–∏ —Ä–æ–∑–∫–∏–¥–∞—î—à –∑–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–æ–±—ñ–≥ –ø–æ —Ä—ñ–∑–Ω–∏–º —Ç–∏–ø–∞–º –¥–æ—Ä—ñ–≥. –ö–æ–∂–Ω–∞ –¥–æ—Ä–æ–≥–∞ –º–∞—î —Å–≤—ñ–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç: –∞—Å—Ñ–∞–ª—å—Ç (0.85) ‚Äî —è–∫ –ª–µ–≥–∫–∏–π –∫—Ä–æ–∫, –∞ –±–µ–∑–¥–æ—Ä—ñ–∂–∂—è (1.35) ‚Äî —è–∫ –º–∞—Ä—à-–∫–∏–¥–æ–∫ –ø–æ –±–æ–ª–æ—Ç—É.
-–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ –ø–æ–ª—è (üîí). –î–µ—è–∫—ñ –ø–æ–ª—è –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –±–µ–∑–¥–æ—Ä—ñ–∂–∂—è), —â–æ–± —ó—Ö –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–µ –∑–º—ñ–Ω—é–≤–∞–ª–∏—Å—è –ø—ñ–¥ —á–∞—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø—ñ–¥–±–æ—Ä—É. –ê–ª–µ —Ç–∏ –º–æ–∂–µ—à –∑–Ω—è—Ç–∏ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —ñ –ø–æ—á–Ω–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø—ñ–¥–±—ñ—Ä. 
-–Ø–∫—â–æ –≤–æ–Ω–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–µ —ñ —Ç–∏ –≤–≤—ñ–≤ —Ç—É–¥–∏ —Å–≤–æ—é –¥–∞–Ω–Ω—ñ —Ç–æ –ø—Ä–æ–≥—Ä–∞–º–µ –Ω–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏–º–µ –∑–Ω–∞—á–µ–Ω–Ω—è, –ª–∏—à–µ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏–º–µ –ø—ñ–¥ —á–∞—Å —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤
-–î–æ–¥–∞—Ç–∫–æ–≤—ñ —É–º–æ–≤–∏. –¢—É—Ç —Ç–∏ –¥–æ–¥–∞—î—à "—Å–º—ñ—à–Ω—ñ" –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏, —è–∫—ñ –∑–±—ñ–ª—å—à—É—é—Ç—å –≤–∏—Ç—Ä–∞—Ç—É:
-–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∏–∂—á–µ 0, –æ–∂–µ–ª–µ–¥–∏—Ü—è, –∫–æ–Ω–¥–∏—Ü—ñ–æ–Ω–µ—Ä, —à–≤–∏–¥–∫—ñ—Å—Ç—å –ø–æ–Ω–∞–¥ 90 –∫–º/–≥–æ–¥ (–¥–ª—è MAN).
-"–¢–µ–Ω–¥—ñ—Ç–Ω–∏–π" –≤–∞–Ω—Ç–∞–∂ (—Ö—Ç–æ—Å—å –∑–∞–±—É–≤ –ø—Ä–æ —Ç–µ—Ä–º–æ—Å—Ç—ñ–π–∫—ñ—Å—Ç—å).
-–í—ñ–∫ —Ç–∞ –ø—Ä–æ–±—ñ–≥ –º–∞—à–∏–Ω–∏, —è–∫—ñ –¥–æ–¥–∞—é—Ç—å –≤—ñ–¥ 3% –¥–æ 9% –¥–æ –≤–∏—Ç—Ä–∞—Ç–∏, –±–æ, —è–∫ —ñ —Ç–∏, –≤–æ–Ω–∞ –≤–∂–µ –Ω–µ –º–æ–ª–æ–¥–∞.
-–í–∞–Ω—Ç–∞–∂. –Ø–∫—â–æ —Ç–≤–æ—è —Ç–∞—á–∫–∞ –≤–æ–∑–∏—Ç—å –≤–∞–Ω—Ç–∞–∂—ñ (—è–∫ MAN TGS), —Ç–∏ –º–æ–∂–µ—à –≤–∫–∞–∑–∞—Ç–∏ –π–æ–≥–æ –≤–∞–≥—É –≤ —Ç–æ–Ω–Ω–∞—Ö. –¶–µ –¥–æ–¥–∞—î —â–µ –±—ñ–ª—å—à–µ –ø–∞–ª—å–Ω–æ–≥–æ –¥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤, –æ—Å–æ–±–ª–∏–≤–æ —è–∫—â–æ –≤–∞–Ω—Ç–∞–∂ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É –≤–µ–∑–ª–∏ —ñ —Ç—É–¥–∏ —ñ –Ω–∞–∑–∞–¥.
	–ö–†–û–ö 6: –†–û–ó–†–ê–•–£–ù–û–ö –¢–ê –†–ï–ó–£–õ–¨–¢–ê–¢
-–î—ñ—ó. –ù–∞—Ç–∏—Å–∫–∞—î—à "–ü—ñ–¥—ñ–±—Ä–∞—Ç–∏", —ñ —Å–∏—Å—Ç–µ–º–∞, —è–∫ —Ö–∏—Ç—Ä–∏–π –∫–æ–º–∞–Ω–¥–∏—Ä, —Å–∞–º–∞ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—î –ø—Ä–æ–±—ñ–≥ –ø–æ –Ω–µ–∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–º –¥–æ—Ä–æ–≥–∞–º, —â–æ–± –∫—ñ–Ω—Ü–µ–≤–∞ –≤–∏—Ç—Ä–∞—Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∑–±—ñ–≥–ª–∞—Å—è –∑ —Ç–≤–æ—î—é "–º–µ—Ç–æ—é".
-–†–µ–∑—É–ª—å—Ç–∞—Ç–∏. –¢–∏ –æ—Ç—Ä–∏–º—É—î—à –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø–∞–ª—å–Ω–æ–≥–æ —ñ –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø—Ä–æ–±—ñ–≥—É. –¶—ñ —Ü–∏—Ñ—Ä–∏ –ø–æ—Ä—ñ–≤–Ω—é—é—Ç—å—Å—è –∑ "–ú–µ—Ç–æ—é". –Ø–∫—â–æ –≤–æ–Ω–∏ –∑–±—ñ–≥–∞—é—Ç—å—Å—è (—Ä—ñ–∑–Ω–∏—Ü—è –º–∞–π–∂–µ –Ω—É–ª—å–æ–≤–∞), —Ç–µ–∫—Å—Ç —Å—Ç–∞—î –∑–µ–ª–µ–Ω–∏–º ‚Äî —Ç–≤—ñ–π –∑–≤—ñ—Ç –ø—Ä–∏–π–Ω—è—Ç–∏–π. –Ø–∫—â–æ –Ω—ñ, –≤—ñ–Ω —á–µ—Ä–≤–æ–Ω–∏–π ‚Äî –π–¥–∏ –ø–µ—Ä–µ—Ä–æ–±–ª—è—Ç–∏, –±–æ –≤ —à—Ç–∞–±—ñ –Ω–∞ —Ç–µ–±–µ –≤–∂–µ —á–µ–∫–∞—é—Ç—å.
-"–ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ–æ—Ä–º—É–ª—É". –¶—è –∫–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä—É—î –≥–æ—Ç–æ–≤—É —Ñ–æ—Ä–º—É–ª—É –∑ —É—Å—ñ–º–∞ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∞–º–∏ —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∞–º–∏. –á—ó –º–æ–∂–Ω–∞ —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —ñ –≤—Å—Ç–∞–≤–∏—Ç–∏ –≤ –∑–≤—ñ—Ç.
	P.S. –¶–µ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ‚Äî —Ü–µ —è–∫ —Ç–≤–æ—è –º–∞–º–∞: –≤—ñ–Ω –Ω–µ –¥–∞—î —Ç–æ–±—ñ –∑–∞–π–≤–∏—Ö –ø–∏—Ç–∞–Ω—å, –∞–ª–µ –∑–∞–≤–∂–¥–∏ –∫–∞–∂–µ —Ç–æ–±—ñ, —â–æ —Ç–∏ —Ä–æ–±–∏—à —â–æ—Å—å –Ω–µ —Ç–∞–∫.`;
            instructionBtn.onclick = () => showHelp('–Ü–ù–°–¢–†–£–ö–¶–Ü–Ø', instructionText);
            container.appendChild(instructionBtn);
            
            const separator = document.createElement('hr');
            separator.style.margin = "1.5rem 0";
            container.appendChild(separator);

            const subs = Object.keys(CARS_DATA).sort();
            subs.forEach(sub => {
                const btn = document.createElement('div');
                btn.className = 'btn';
                btn.textContent = sub;
                btn.onclick = () => selectSubdivision(sub);
                container.appendChild(btn);
            });
        }
        function selectSubdivision(sub) { state.subdivision = sub; const types = Object.keys(CARS_DATA[sub]).sort(); if (!types.some(t => Object.keys(CARS_DATA[sub][t]).length > 0)) { showAlert("–£ —Ü—å–æ–º—É –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ –Ω–µ–º–∞—î –∞–≤—Ç–æ–º–æ–±—ñ–ª—ñ–≤."); return; } renderTypes(types); showScreen('screen-type'); }
        function renderTypes(types) { const container = document.getElementById('type-buttons'); container.innerHTML = ''; types.forEach(type => { if (Object.keys(CARS_DATA[state.subdivision][type]).length > 0) { const btn = document.createElement('div'); btn.className = 'btn'; btn.textContent = type; btn.onclick = () => selectType(type); container.appendChild(btn); } }); }
        function selectType(type) { state.type = type; const cars = Object.keys(CARS_DATA[state.subdivision][type]).sort(); if (cars.length === 0) { showAlert("–£ —Ü—å–æ–º—É —Ç–∏–ø—ñ –Ω–µ–º–∞—î –∞–≤—Ç–æ–º–æ–±—ñ–ª—ñ–≤."); return; } renderCars(cars); showScreen('screen-car'); }
        function renderCars(cars) { const container = document.getElementById('car-buttons'); container.innerHTML = ''; cars.forEach(car => { const btn = document.createElement('div'); btn.className = 'btn'; btn.textContent = car; btn.onclick = () => selectCar(car); container.appendChild(btn); }); }
        function selectCar(carName) { state.carName = carName; state.carInfo = CARS_DATA[state.subdivision][state.type][carName]; renderCalculator(); showScreen('screen-calculator'); }
        function resetCalculator() { document.getElementById('calculator-content').innerHTML = ''; }

        function renderCalculator() {
            const container = document.getElementById('calculator-content');
            container.innerHTML = ''; 
            document.getElementById('car-info').textContent = `${state.subdivision} / ${state.type} / ${state.carName}`;
            
            const isCargoCar = state.carInfo.cargo;
            const hasAircon = state.carInfo.aircon;
            const fields_to_lock_by_default = ["–í–µ–ª–∏–∫—ñ –º—ñ—Å—Ç–∞, –æ–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏", "–ö–∏—ó–≤, –î–Ω—ñ–ø—Ä–æ, –•–∞—Ä–∫—ñ–≤ —ñ –ø–æ–¥—ñ–±–Ω—ñ", "–ü–æ –±—Ä—É–∫–æ–≤–æ-—â–µ–±–Ω–µ–≤–æ–º—É —à–æ—Å–µ —ñ —Ç–≤–µ—Ä–¥—ñ–π —Å—Ç–µ–ø–æ–≤—ñ–π —Ü—ñ–ª–∏–Ω—ñ", "–ü–æ “ë—Ä—É–Ω—Ç–æ–≤–∏—Ö –¥–æ—Ä–æ–≥–∞—Ö —ñ –¥–æ—Ä–æ–≥–∞—Ö –∑ –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω–∏–º–∏ –ø—ñ—Å–∫–∞–º–∏", "–£ –≤–∞–∂–∫–∏—Ö –¥–æ—Ä–æ–∂–Ω—ñ—Ö —É–º–æ–≤–∞—Ö (–±–µ–∑–¥–æ—Ä—ñ–∂–∂—è, —Å–Ω—ñ–≥, –ø—ñ—Å–æ–∫)"];

            const cargoHtml = isCargoCar ? `<div class="input-group"><input type="number" inputmode="decimal" id="cargo_weight" placeholder="–í–∞–≥–∞ –≤–∞–Ω—Ç–∞–∂—É (—Ç)" oninput="updateCalculation()"></div><div class="switch-container"><span class="label-text">–í–∞–Ω—Ç–∞–∂ —Ç—ñ–ª—å–∫–∏ –≤ –æ–¥–∏–Ω –±—ñ–∫</span><label class="switch"><input type="checkbox" id="cargo_one_way" onchange="updateCalculation()"><span class="slider"></span></label></div>` : '';
            
            container.innerHTML = `
                <div class="title-wrapper" style="margin-bottom: 0.75rem;"><h2>–ü–æ–∫–∞–∑–Ω–∏–∫–∏ –æ–¥–æ–º–µ—Ç—Ä–∞</h2><div class="help-btn" onclick="showHelp('–ü–æ–∫–∞–∑–Ω–∏–∫–∏ –æ–¥–æ–º–µ—Ç—Ä–∞', '...')">?</div></div>
                <div class="input-group"><input type="number" inputmode="decimal" id="odo_start" placeholder="–û–¥–æ–º–µ—Ç—Ä –Ω–∞ –ø–æ—á–∞—Ç–∫—É (–∫–º)" oninput="calculateOdometerData()"></div>
                <div class="input-group"><input type="number" inputmode="decimal" id="odo_end" placeholder="–û–¥–æ–º–µ—Ç—Ä –Ω–∞ –∫—ñ–Ω–µ—Ü—å (–∫–º)" oninput="calculateOdometerData()"></div>
                <h3>–†—É—Ö –ø–∞–ª—å–Ω–æ–≥–æ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</h3>
                <div class="input-group"><input type="number" inputmode="decimal" id="fuel_start" placeholder="–ù–∞—è–≤–Ω—ñ—Å—Ç—å (–ª)" oninput="calculateOdometerData()"></div>
                <div class="input-group"><input type="number" inputmode="decimal" id="fuel_received" placeholder="–û—Ç—Ä–∏–º–∞–Ω–æ (–ª)" oninput="calculateOdometerData()"></div>
                <div class="input-group"><input type="number" inputmode="decimal" id="fuel_end" placeholder="–ó–∞–ª–∏—à–æ–∫ (–ª)" oninput="calculateOdometerData()"></div>
                <h1 class="my-4">–ê–ë–û</h1>
                <div class="title-wrapper" style="margin-bottom: 0.75rem;"><h2>–ú–µ—Ç–∞</h2><div class="help-btn" onclick="showHelp('–ú–µ—Ç–∞', '...')">?</div></div>
                <div class="input-group"><div class="input-wrapper"><input type="number" inputmode="decimal" id="target_dist" placeholder="–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–æ–±—ñ–≥ (–∫–º)" oninput="updateCalculation()"><div class="btn btn-clear" onclick="clearInput('target_dist')">–û—á–∏—Å—Ç–∏—Ç–∏</div></div></div>
                <div class="input-group"><div class="input-wrapper"><input type="number" inputmode="decimal" id="target_fuel" placeholder="–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∏—Ç—Ä–∞—Ç–∞ (–ª)" oninput="updateCalculation()"><div class="btn btn-clear" onclick="clearInput('target_fuel')">–û—á–∏—Å—Ç–∏—Ç–∏</div></div><p id="base_rate_consumption_meta" class="result-diff mt-2"></p></div>
                <hr>
                <div class="result-box"><div class="title-wrapper" style="margin-bottom: 0.75rem;"><h2>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h2><div class="help-btn" onclick="showHelp('–†–µ–∑—É–ª—å—Ç–∞—Ç–∏', '...')">?</div></div><p>–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø–∞–ª—å–Ω–æ–≥–æ:</p><p id="calculated_fuel" class="result-value">0.00 –ª</p><p id="fuel_diff" class="result-diff">–†—ñ–∑–Ω–∏—Ü—è: +0.00 –ª</p><p class="mt-4">–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø—Ä–æ–±—ñ–≥—É:</p><p id="calculated_dist" class="result-value">0.0 –∫–º</p><p id="dist_diff" class="result-diff">–†—ñ–∑–Ω–∏—Ü—è: +0.0 –∫–º</p></div>
                <hr>
                <div class="title-wrapper" style="margin-bottom: 0.75rem;"><h2>–î—ñ—ó</h2><div class="help-btn" onclick="showHelp('–î—ñ—ó', '...')">?</div></div>
                <div class="mt-2"><div class="btn btn-primary" onclick="randomizeDistances()">–ü—ñ–¥—ñ–±—Ä–∞—Ç–∏</div><div class="btn" onclick="openDistributionModal()">–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö</div><div class="btn mt-2" onclick="showFormula()">–ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ–æ—Ä–º—É–ª—É</div></div>
                ${isCargoCar ? `<hr><div class="title-wrapper" style="margin-bottom: 0.75rem;"><h2>–í–∞–Ω—Ç–∞–∂</h2><div class="help-btn" onclick="showHelp('–í–∞–Ω—Ç–∞–∂', '...')">?</div></div>` + cargoHtml : ''}
                <hr>
                <div class="title-wrapper" style="margin-bottom: 0.75rem;"><h2>–í—ñ–¥—Ä—ñ–∑–∫–∏ —à–ª—è—Ö—É (–∫–º)</h2><div class="help-btn" onclick="showHelp('–í—ñ–¥—Ä—ñ–∑–∫–∏ —à–ª—è—Ö—É', '...')">?</div></div>
                ${SEGMENT_ORDER.map(name => {
                    const coeff = ROAD_COEFFS[name]; 
                    const percent_diff = (coeff - 1) * 100; 
                    const percent_str = `(${(percent_diff >= 0 ? '+' : '')}${percent_diff.toFixed(0)}%)`;
                    const isLockedByDefault = fields_to_lock_by_default.includes(name);
                    const safeId = `segment-${name.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    return `<div class="input-group"><label><span class="label-text">${name} ${percent_str}</span><label class="switch" title="–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ –ø–æ–ª–µ"><span class="lock-icon">üîí</span><input type="checkbox" class="segment-lock" data-name="${name}" ${isLockedByDefault ? 'checked' : ''}><span class="slider"></span></label></label><div class="input-wrapper"><input type="number" inputmode="decimal" class="segment-dist" data-name="${name}" id="${safeId}" placeholder="0" oninput="updateCalculation()"><div class="btn btn-clear" onclick="clearInput('${safeId}')">–û—á–∏—Å—Ç–∏—Ç–∏</div></div></div>`
                }).join('')}
                <hr>
                <div class="title-wrapper" style="margin-bottom: 0.75rem;"><h2>–î–æ–¥–∞—Ç–∫–æ–≤—ñ —É–º–æ–≤–∏</h2><div class="help-btn" onclick="showHelp('–î–æ–¥–∞—Ç–∫–æ–≤—ñ —É–º–æ–≤–∏', '...')">?</div></div>
                ${Object.keys(ADDITIVE_COEFFS).filter(name => !(name === '–ö–æ–Ω–¥–∏—Ü—ñ–æ–Ω–µ—Ä' && !hasAircon)).map(name => { const percent = ADDITIVE_COEFFS[name] * 100; const percent_str = `(+${percent.toFixed(0)}%)`; return `<div class="switch-container"><span class="label-text">${name} ${percent_str}</span><label class="switch"><input type="checkbox" class="additive-coeff" data-name="${name}" onchange="updateCalculation()"><span class="slider"></span></label></div>` }).join('')}`;
            updateCalculation();
        }
        
        function clearInput(elementId) { const el = document.getElementById(elementId); if (el) { el.value = ''; updateCalculation(); } }

        function calculateOdometerData() {
            const odo_start = parseFloat(document.getElementById('odo_start')?.value) || 0;
            const odo_end = parseFloat(document.getElementById('odo_end')?.value) || 0;
            const fuel_start = parseFloat(document.getElementById('fuel_start')?.value) || 0;
            const fuel_received = parseFloat(document.getElementById('fuel_received')?.value) || 0;
            const fuel_end = parseFloat(document.getElementById('fuel_end')?.value) || 0;
            const target_dist_el = document.getElementById('target_dist');
            const target_fuel_el = document.getElementById('target_fuel');
            const calculated_dist = odo_end - odo_start;
            if (calculated_dist > 0) { target_dist_el.value = calculated_dist.toFixed(1); } 
            else if (odo_start > 0 && odo_end > 0) { target_dist_el.value = ''; }
            const calculated_fuel = fuel_start + fuel_received - fuel_end;
            if (calculated_fuel > 0) { target_fuel_el.value = calculated_fuel.toFixed(2); } 
            else if (fuel_start > 0 || fuel_received > 0 || fuel_end > 0) { target_fuel_el.value = ''; }
            updateCalculation();
        }

        function getValues() { const values = { segments: {}, additives: {} }; document.querySelectorAll('.segment-dist').forEach(el => { values.segments[el.dataset.name] = parseFloat(el.value) || 0; }); document.querySelectorAll('.additive-coeff').forEach(el => { values.additives[el.dataset.name] = el.checked; }); values.target_fuel = parseFloat(document.getElementById('target_fuel')?.value) || 0; values.target_dist = parseFloat(document.getElementById('target_dist')?.value) || 0; values.cargo_weight = parseFloat(document.getElementById('cargo_weight')?.value) || 0; values.cargo_one_way = document.getElementById('cargo_one_way')?.checked || false; return values; }
        function getCurrentCalculation(segments_dict, dist_override = null, cargo_w_override = null, one_way_override = null) { if (!state.carInfo) return { total_fuel: 0, total_dist: 0 }; const inputs = getValues(); const base_rate_100km = state.carInfo.consumption; const road_work = Object.entries(segments_dict).reduce((sum, [name, dist]) => sum + dist * ROAD_COEFFS[name], 0); const total_dist = dist_override !== null ? dist_override : Object.values(segments_dict).reduce((sum, dist) => sum + dist, 0); const k_add = Object.entries(inputs.additives).reduce((sum, [name, checked]) => sum + (checked ? ADDITIVE_COEFFS[name] : 0), 0); const cargo_w = cargo_w_override !== null ? cargo_w_override : inputs.cargo_weight; const is_one_way = one_way_override !== null ? one_way_override : inputs.cargo_one_way; const cargo_dist = is_one_way ? total_dist / 2 : total_dist; const engine_type = state.carInfo.engine_type || "–¥–∏–∑–µ–ª—å"; const cargo_coeff = CARGO_COEFFS[engine_type.toLowerCase()] || 1.3; const cargo_fuel = (cargo_coeff * cargo_w * cargo_dist) / 100; const total_fuel = ((base_rate_100km / 100) * road_work) * (1 + k_add) + cargo_fuel; return { total_fuel, total_dist }; }
        function updateCalculation() { if (!state.carInfo) return; const inputs = getValues(); const { total_fuel, total_dist } = getCurrentCalculation(inputs.segments); document.getElementById('calculated_fuel').textContent = `${total_fuel.toFixed(2)} –ª`; const fuel_difference = total_fuel - inputs.target_fuel; const fuel_diff_el = document.getElementById('fuel_diff'); fuel_diff_el.textContent = `–†—ñ–∑–Ω–∏—Ü—è: ${fuel_difference >= 0 ? '+' : ''}${fuel_difference.toFixed(2)} –ª`; fuel_diff_el.style.color = Math.abs(fuel_difference) < 0.01 ? 'var(--success-color)' : 'var(--error-color)'; const base_rate_100km = state.carInfo.consumption; const target_dist = inputs.target_dist; const base_consumption = (base_rate_100km * target_dist) / 100; const base_consumption_el = document.getElementById('base_rate_consumption_meta'); if (base_consumption_el) { if (target_dist > 0) { base_consumption_el.innerHTML = `–í–∏—Ç—Ä–∞—Ç–∞ –∑–≥—ñ–¥–Ω–æ –±–∞–∑–æ–≤–æ—ó –ª—ñ–Ω—ñ–π–Ω–æ—ó –Ω–æ—Ä–º–∏: ${base_rate_100km.toFixed(1)} –ª/<sub>100–∫–º</sub> x ${target_dist.toFixed(1)} –∫–º x 0.01 = <span class="base-result">${base_consumption.toFixed(1)} –ª</span>`; } else { base_consumption_el.innerHTML = ''; } } document.getElementById('calculated_dist').textContent = `${total_dist.toFixed(1)} –∫–º`; const dist_difference = total_dist - inputs.target_dist; const dist_diff_el = document.getElementById('dist_diff'); dist_diff_el.textContent = `–†—ñ–∑–Ω–∏—Ü—è: ${dist_difference >= 0 ? '+' : ''}${dist_difference.toFixed(1)} –∫–º`; dist_diff_el.style.color = Math.abs(dist_difference) < 0.1 ? 'var(--success-color)' : 'var(--error-color)'; }
        function randomizeDistances() { if (!state.carInfo) return showAlert("–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –∞–≤—Ç–æ–º–æ–±—ñ–ª—å."); let target_dist = parseFloat(document.getElementById('target_dist').value) || 0; let target_fuel = parseFloat(document.getElementById('target_fuel').value) || 0; if (target_dist <= 0 && target_fuel <= 0) return showAlert("–í–≤–µ–¥—ñ—Ç—å –º–µ—Ç—É –ø–æ –ø—Ä–æ–±—ñ–≥—É –∞–±–æ –ø–æ –≤–∏—Ç—Ä–∞—Ç—ñ."); if (target_dist > 0 && target_fuel <= 0) { const tempSegments = getValues().segments; if (Object.values(tempSegments).every(v => v === 0)) { const base_rate_100km = state.carInfo.consumption; target_fuel = (base_rate_100km * target_dist) / 100; } else { const { total_fuel } = getCurrentCalculation(tempSegments, target_dist); target_fuel = total_fuel; } document.getElementById('target_fuel').value = target_fuel.toFixed(2); } else if (target_fuel > 0 && target_dist <= 0) { const tempSegments = getValues().segments; const currentDist = Object.values(tempSegments).reduce((s, d) => s + d, 0); if (currentDist > 0) { const { total_fuel: fuelForCurrentDist } = getCurrentCalculation(tempSegments); if (fuelForCurrentDist > 0) { const estimated_dist = (target_fuel / fuelForCurrentDist) * currentDist; target_dist = estimated_dist; document.getElementById('target_dist').value = estimated_dist.toFixed(1); } else { return showAlert("–ù–µ–º–æ–∂–ª–∏–≤–æ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –ø—Ä–æ–±—ñ–≥ –∑ –ø–æ—Ç–æ—á–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏. –í–≤–µ–¥—ñ—Ç—å –ø—Ä–æ–±—ñ–≥ –≤—Ä—É—á–Ω—É."); } } else { return showAlert("–ù–µ–º–æ–∂–ª–∏–≤–æ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –ø—Ä–æ–±—ñ–≥ –±–µ–∑ –≤–≤–µ–¥–µ–Ω–∏—Ö –≤—ñ–¥—Ä—ñ–∑–∫—ñ–≤ —à–ª—è—Ö—É. –í–≤–µ–¥—ñ—Ç—å –ø—Ä–æ–±—ñ–≥ –≤—Ä—É—á–Ω—É –∞–±–æ –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—ñ–¥—Ä—ñ–∑–∫–∏."); } } const manual_coeffs = [1.3, 1.35]; const locked_segments = {}; const auto_segments_names = []; document.querySelectorAll('.segment-lock').forEach(el => { const name = el.dataset.name; const dist_el = document.querySelector(`.segment-dist[data-name="${name}"]`); if (el.checked || manual_coeffs.includes(ROAD_COEFFS[name])) { locked_segments[name] = parseFloat(dist_el.value) || 0; } else { auto_segments_names.push(name); } }); if (auto_segments_names.length === 0) return showAlert("–ù–µ–º–∞—î –ø–æ–ª—ñ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ —Ä–æ–∑–ø–æ–¥—ñ–ª—É. –†–æ–∑–±–ª–æ–∫—É–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –ø–æ–ª–µ."); const locked_dist = Object.values(locked_segments).reduce((s, d) => s + d, 0); const { total_fuel: locked_fuel } = getCurrentCalculation(locked_segments); let remaining_dist = target_dist - locked_dist; if (remaining_dist < 0) return showAlert("–ü—Ä–æ–±—ñ–≥ –Ω–∞ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏—Ö –ø–æ–ª—è—Ö –ø–µ—Ä–µ–≤–∏—â—É—î –∑–∞–≥–∞–ª—å–Ω—É –º–µ—Ç—É."); let remaining_fuel_target = target_fuel - locked_fuel; const weights = auto_segments_names.map(name => { const coeff = ROAD_COEFFS[name]; if (coeff < 1.0) return 10; if (coeff < 1.15) return 4; return 1; }); const rand_values = weights.map(w => Math.random() * w); const total_rand = rand_values.reduce((s, r) => s + r, 0); if (total_rand === 0) return; let current_dists = {}; auto_segments_names.forEach((name, i) => { current_dists[name] = (rand_values[i] / total_rand) * remaining_dist; }); for (let i = 0; i < 3000; i++) { const { total_fuel: current_fuel } = getCurrentCalculation(current_dists); const fuel_diff = current_fuel - remaining_fuel_target; if (Math.abs(fuel_diff) < 0.01) break; const fuel_costs = {}; auto_segments_names.forEach(name => { fuel_costs[name] = getCurrentCalculation({[name]: 1}).total_fuel; }); const cheapest = Object.keys(fuel_costs).reduce((a, b) => fuel_costs[a] < fuel_costs[b] ? a : b); const most_expensive = Object.keys(fuel_costs).reduce((a, b) => fuel_costs[a] > fuel_costs[b] ? a : b); if (cheapest === most_expensive) break; const adjustment = Math.min(Math.abs(fuel_diff) * 0.1, 1.0); if (fuel_diff > 0) { if (current_dists[most_expensive] > adjustment) { current_dists[most_expensive] -= adjustment; current_dists[cheapest] += adjustment; } else break; } else { if (current_dists[cheapest] > adjustment) { current_dists[cheapest] -= adjustment; current_dists[most_expensive] += adjustment; } else break; } } let int_dists = {}; let remainder = remaining_dist; for(const name of auto_segments_names) { int_dists[name] = Math.floor(current_dists[name]); remainder -= int_dists[name]; } const sorted_by_remainder = auto_segments_names.sort((a,b) => (current_dists[b] - int_dists[b]) - (current_dists[a] - int_dists[a])); for(let i = 0; i < Math.round(remainder); i++) { int_dists[sorted_by_remainder[i % sorted_by_remainder.length]] += 1; } for(const name of auto_segments_names) { const dist_el = document.querySelector(`.segment-dist[data-name="${name}"]`); dist_el.value = int_dists[name] > 0 ? int_dists[name] : ''; } updateCalculation(); }
        function generateFormulaString(custom_segments, custom_dist, custom_cargo, custom_one_way) { try { const values = getValues(); const { total_fuel, total_dist } = getCurrentCalculation( custom_segments || values.segments, custom_dist, custom_cargo, custom_one_way ); const base_rate_100km = state.carInfo.consumption; const additive_parts = Object.entries(values.additives).filter(([_, checked]) => checked).map(([name, _]) => `${(ADDITIVE_COEFFS[name]*100).toFixed(0)}%`); const k_add_sum = Object.entries(values.additives).reduce((sum, [name, checked]) => sum + (checked ? ADDITIVE_COEFFS[name] : 0), 0); const final_rate = base_rate_100km * (1 + k_add_sum); const formula1 = `–ë–∞–∑–æ–≤–∞ –ª—ñ–Ω—ñ–π–Ω–∞ –Ω–æ—Ä–º–∞ –≤–∏—Ç—Ä–∞—Ç ${base_rate_100km.toFixed(2)}–ª/100–∫–º + ${additive_parts.length > 0 ? additive_parts.join(' + ') : '0%'} = ${final_rate.toFixed(2)}–ª/100–∫–º.`; const road_str_parts = []; const template_coeffs = [0.85, 0.9, 1.0, 1.05, 1.1, 1.15, 1.25, 1.3, 1.35]; const coeff_to_name_map = Object.fromEntries(Object.entries(ROAD_COEFFS).map(([k,v]) => [v,k])); const segments_to_use = custom_segments || values.segments; for (const coeff of template_coeffs) { let dist_found = 0; if(coeff_to_name_map[coeff] && segments_to_use[coeff_to_name_map[coeff]]) { dist_found = segments_to_use[coeff_to_name_map[coeff]]; } road_str_parts.push(`(${String(coeff).replace('.',',')}x${Math.round(dist_found)})`); } const road_str = road_str_parts.join('+'); const cargo_w = custom_cargo ?? values.cargo_weight; const one_way = custom_one_way ?? values.cargo_one_way; const cargo_str = isNaN(cargo_w) || cargo_w === 0 ? "" : `+1,3*(${cargo_w.toFixed(1)}—Ç${one_way ? '/2' : ''})`; const formula2 = `–í—Å—å–æ–≥–æ ${Math.round(total_dist)}–∫–º; (${final_rate.toFixed(2)}–ª/100–∫–º${cargo_str})x((${road_str}))x0,01=${total_fuel.toFixed(2)}–ª;`; return {formula1, formula2, total_fuel}; } catch (e) { console.error("Formula generation error:", e); return { formula1: "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ñ–æ—Ä–º—É–ª–∏.", formula2: "", total_fuel: 0 }; } }
        function showFormula() { const { formula1, formula2 } = generateFormulaString(); document.getElementById('formula-modal-title').textContent = "–§–æ—Ä–º—É–ª–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É"; document.getElementById('formula-text').textContent = `${formula1}\n\n${formula2}`; document.getElementById('formula-modal').style.display = 'flex'; }
        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => { showAlert('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!'); }).catch(err => { showAlert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏.'); }); }
        function copyFormula() { const formulaText = document.getElementById('formula-text').textContent; copyToClipboard(formulaText); closeModal('formula-modal'); }
        let routeData = [];
        function openDistributionModal() { renderDistributionTable(15); updateDistributionTotals(); document.getElementById('distribution-modal').style.display = 'flex'; }
        function addRouteRow() { if (routeData.length >= 30) { showAlert('–î–æ—Å—è–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (30).'); return; } renderDistributionTable(routeData.length + 1); }
        function renderDistributionTable(rowCount) { const table = document.getElementById('dist-table'); const isCargoCar = state.carInfo.cargo; const masterSegments = getValues().segments; let headerHtml = `<div class="cell header">–ú–∞—Ä—à—Ä—É—Ç</div><div class="cell header">–ó–∞–≥. –ø—Ä–æ–±—ñ–≥</div>`; if (isCargoCar) { headerHtml += `<div class="cell header">–í–∞–≥–∞ (—Ç)</div><div class="cell header">1 –±—ñ–∫</div>`; } SEGMENT_ORDER.forEach(name => { const coeff = ROAD_COEFFS[name]; const isActive = (masterSegments[name] || 0) > 0; headerHtml += `<div class="cell header"><div>${coeff}</div><input type="checkbox" data-col-name="${name}" onchange="toggleColumnCheckboxes(this)" ${isActive ? 'checked':''}></div>`; }); let bodyHtml = ''; const existingRowCount = routeData.length; if (rowCount < existingRowCount) { routeData = routeData.slice(0, rowCount); } for(let i=0; i<rowCount; i++) { if (i >= existingRowCount) { routeData.push({ dist: '', cargo: '', oneWay: false, allowed: Object.fromEntries(SEGMENT_ORDER.map(name => [name, (masterSegments[name] || 0) > 0])) }); } else { routeData[i].allowed = Object.fromEntries(SEGMENT_ORDER.map(name => [name, (masterSegments[name] || 0) > 0])); } const route = routeData[i]; bodyHtml += `<div class="cell">‚Ññ${i + 1}</div>`; bodyHtml += `<div class="cell"><input type="number" inputmode="decimal" value="${route.dist}" oninput="routeData[${i}].dist = this.value; updateDistributionTotals();"></div>`; if(isCargoCar) { bodyHtml += `<div class="cell"><input type="number" inputmode="decimal" value="${route.cargo}" oninput="routeData[${i}].cargo = this.value; updateDistributionTotals();"></div>`; bodyHtml += `<div class="cell"><input type="checkbox" ${route.oneWay ? 'checked' : ''} onchange="routeData[${i}].oneWay = this.checked;"></div>`; } SEGMENT_ORDER.forEach(name => { bodyHtml += `<div class="cell"><input type="checkbox" data-col-name="${name}" ${route.allowed[name] ? 'checked' : ''} onchange="routeData[${i}].allowed['${name}'] = this.checked;"></div>`; }); } const columnCount = 2 + (isCargoCar ? 2 : 0) + SEGMENT_ORDER.length; table.style.gridTemplateColumns = `60px 80px ${isCargoCar ? '80px 40px' : ''} repeat(${SEGMENT_ORDER.length}, 60px)`; table.innerHTML = headerHtml + bodyHtml; }
        function toggleColumnCheckboxes(headerCheckbox) { const name = headerCheckbox.dataset.colName; const isChecked = headerCheckbox.checked; document.querySelectorAll(`#dist-table input[type="checkbox"][data-col-name="${name}"]`).forEach((cb, index) => { if (index > 0 && routeData[index - 1]) { cb.checked = isChecked; routeData[index - 1].allowed[name] = isChecked; } }); }
        function updateDistributionTotals() { const target_dist = parseFloat(document.getElementById('target_dist')?.value) || 0; const entered_dist = routeData.reduce((sum, route) => sum + (parseFloat(route.dist) || 0), 0); document.getElementById('remaining-dist-label').textContent = `–ó–∞–ª–∏—à–æ–∫ –¥–ª—è —Ä–æ–∑–ø–æ–¥—ñ–ª—É: ${(target_dist - entered_dist).toFixed(1)} –∫–º`; if (state.carInfo.cargo) { const target_cargo = parseFloat(document.getElementById('cargo_weight')?.value) || 0; const entered_cargo = routeData.reduce((sum, route) => sum + (parseFloat(route.cargo) || 0), 0); document.getElementById('remaining-cargo-label').textContent = `–ó–∞–ª–∏—à–æ–∫ –≤–∞–Ω—Ç–∞–∂—É: ${(target_cargo - entered_cargo).toFixed(1)} —Ç`; document.getElementById('remaining-cargo-label').style.display = 'block'; } else { document.getElementById('remaining-cargo-label').style.display = 'none'; } }
        function runDistribution() {
            const masterSegments = getValues().segments; const targetFuel = parseFloat(document.getElementById('target_fuel')?.value) || 0; const routes = routeData.map((rd, i) => ({ id: i + 1, total_dist: parseFloat(rd.dist) || 0, allowed: Object.keys(rd.allowed).filter(name => rd.allowed[name]), cargo: parseFloat(rd.cargo) || 0, one_way: rd.oneWay, result: Object.fromEntries(SEGMENT_ORDER.map(name => [name, 0])) })).filter(r => r.total_dist > 0);
            if (routes.length === 0) return showAlert('–ù–µ –≤–≤–µ–¥–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É –∑ –ø—Ä–æ–±—ñ–≥–æ–º.');
            for (const route of routes) { if (route.allowed.length === 0 && route.total_dist > 0) return showAlert(`–ü–æ–º–∏–ª–∫–∞: –¥–ª—è –º–∞—Ä—à—Ä—É—Ç—É ‚Ññ${route.id} –≤–∫–∞–∑–∞–Ω–æ –ø—Ä–æ–±—ñ–≥, –∞–ª–µ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –¥–æ–∑–≤–æ–ª–µ–Ω–æ–≥–æ —Ç–∏–ø—É –¥–æ—Ä—ñ–≥ (—Å—Ç–æ–≤–ø—á–∏–∫–∞).`);}
            const totalRouteKm = routes.reduce((sum, route) => sum + route.total_dist, 0); if (totalRouteKm <= 0) return showAlert('–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–æ–±—ñ–≥ –ø–æ –≤—Å—ñ—Ö –º–∞—Ä—à—Ä—É—Ç–∞—Ö –¥–æ—Ä—ñ–≤–Ω—é—î –Ω—É–ª—é. –†–æ–∑–ø–æ–¥—ñ–ª –Ω–µ–º–æ–∂–ª–∏–≤–∏–π.');
            for (const name in masterSegments) { const totalKmForSegment = masterSegments[name]; let totalKmOfAllowedRoutes = 0; routes.forEach(route => { if (route.allowed.includes(name)) { totalKmOfAllowedRoutes += route.total_dist; } }); if (totalKmOfAllowedRoutes > 0) { routes.forEach(route => { if (route.allowed.includes(name)) { const proportion = route.total_dist / totalKmOfAllowedRoutes; route.result[name] = totalKmForSegment * proportion; } }); } }
            routes.forEach(route => { const currentSum = Object.values(route.result).reduce((s, d) => s + d, 0); if (currentSum > 0) { const correctionFactor = route.total_dist / currentSum; for(const name in route.result) { route.result[name] *= correctionFactor; } } });
            for(const name in masterSegments) { const totalForSegment = Math.round(masterSegments[name] || 0); let currentTotal = 0; routes.forEach(r => { r.result[name] = Math.round(r.result[name]); currentTotal += r.result[name]; }); let diff = totalForSegment - currentTotal; if(diff !== 0) { const eligibleRoutes = routes.filter(r => r.allowed.includes(name)); if(eligibleRoutes.length > 0) { for(let i=0; i < Math.abs(diff); i++){ const routeToAdjust = eligibleRoutes[i % eligibleRoutes.length]; if (routeToAdjust.result[name] + Math.sign(diff) >= 0) { routeToAdjust.result[name] += Math.sign(diff); } } } } }
            routes.forEach(route => { const currentRouteSum = Object.values(route.result).reduce((sum, dist) => sum + dist, 0); let routeDiff = Math.round(route.total_dist) - currentRouteSum; if (routeDiff !== 0) { const eligibleSegments = route.allowed.filter(name => (route.result[name] > 0 || routeDiff > 0)); if (eligibleSegments.length > 0) { for (let i = 0; i < Math.abs(routeDiff); i++) { const segmentToAdjust = eligibleSegments[i % eligibleSegments.length]; if (route.result[segmentToAdjust] + Math.sign(routeDiff) >= 0) { route.result[segmentToAdjust] += Math.sign(routeDiff); } else { const anotherSegment = eligibleSegments[(i + 1) % eligibleSegments.length]; if(anotherSegment && route.result[anotherSegment] + Math.sign(routeDiff) >= 0) { route.result[anotherSegment] += Math.sign(routeDiff); } } } } } });
            const { formula1 } = generateFormulaString(); let report = `${formula1}\n–í—Å—å–æ–≥–æ –≤–∏—Ç—Ä–∞—Ç–∞ (–º–µ—Ç–∞): ${targetFuel.toFixed(2)} –ª\n\n` + "=".repeat(80) + "\n" + "–†–û–ó–ü–û–î–Ü–õ –ü–û –ú–ê–†–®–†–£–¢–ê–•".padStart(50) + "\n" + "=".repeat(80);
            let validationErrors = []; let totalValidatedFuel = 0; let validatedSegments = Object.fromEntries(SEGMENT_ORDER.map(name => [name, 0]));
            routes.forEach(route => { const { formula2, total_fuel } = generateFormulaString(route.result, route.total_dist, route.cargo, route.one_way); report += `\n\n–ú–∞—Ä—à—Ä—É—Ç ${route.id} - ${formula2}`; totalValidatedFuel += total_fuel; for(const name in route.result) { validatedSegments[name] += route.result[name]; } });
            const fuelDifference = totalValidatedFuel - targetFuel; if (Math.abs(fuelDifference) > 0.5) { let errorMessage = `- –ó–∞–≥–∞–ª—å–Ω–∞ –≤–∏—Ç—Ä–∞—Ç–∞ –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö (${totalValidatedFuel.toFixed(2)} –ª) –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è –∑ –º–µ—Ç–æ—é (${targetFuel.toFixed(2)} –ª).`; if (Math.abs(fuelDifference) >= 2.0) { errorMessage = `‚ÄºÔ∏è –£–í–ê–ì–ê: –°–£–¢–¢–Ñ–í–ê –†–û–ó–ë–Ü–ñ–ù–Ü–°–¢–¨!\n${errorMessage}`; } validationErrors.push(errorMessage); }
            for(const name in masterSegments) { if (Math.abs(validatedSegments[name] - Math.round(masterSegments[name])) > 0) { validationErrors.push(`- –†–æ–∑–ø–æ–¥—ñ–ª –ø–æ "${name}" (${validatedSegments[name]} –∫–º) –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è –∑ –≥–æ–ª–æ–≤–Ω–∏–º –µ–∫—Ä–∞–Ω–æ–º (${Math.round(masterSegments[name])} –∫–º).`); } }
            report += "\n\n" + "=".repeat(80) + "\n" + "–§–Ü–ù–ê–õ–¨–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê".padStart(48) + "\n" + "=".repeat(80) + "\n";
            if (validationErrors.length === 0) { report += "\n(‚úì –£–°–ü–Ü–•): –£—Å—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –∑–±—ñ–≥–∞—é—Ç—å—Å—è. –§–æ—Ä–º—É–ª–∏ –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤–∞–Ω—ñ —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –¥—ñ–π—Å–Ω–æ—Å—Ç—ñ."; } else { report += "\n(‚ùå –ü–û–ú–ò–õ–ö–ê): –í–∏—è–≤–ª–µ–Ω–æ —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç—ñ –≤ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∞—Ö:\n" + validationErrors.join("\n"); }
            document.getElementById('formula-modal-title').textContent = "–î–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç"; document.getElementById('formula-text').textContent = report; document.getElementById('formula-modal').style.display = 'flex';
        }

        document.addEventListener('DOMContentLoaded', () => {
            if ('serviceWorker' in navigator) {
              window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                  .then(reg => console.log('Service worker registered.', reg))
                  .catch(err => console.log('Service worker not registered.', err));
              });
            }
            renderSubdivisions();
            showScreen('screen-subdivision');
        });
    </script>
</body>
</html>
